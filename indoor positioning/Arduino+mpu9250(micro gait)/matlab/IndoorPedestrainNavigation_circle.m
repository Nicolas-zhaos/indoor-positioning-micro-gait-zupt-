

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Error state matrix : delta_x=[delta_fai,  delta_w,      delta_r,    delta_v,   delta_a];
% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


clear;


Path ='Circle_3_0228.txt';
data = load(Path);
timestamp = data(:,1);
datasize = length(timestamp);

acc_s = data(:,2:4)';
gyro_s = data(:,5:7)';

%initialization
g0 = 9.78049; %Equatorial gravity acceleration赤道重力加速度
U = 34; %latitude纬度
h = 420; %altitude海拔
g = g0*(1+0.0052884*sin(U)^2 - h*3.14e-7) - 0.0000059*sin(2*U)^2; %Calculate gravity

%Direction angle initialization方向角初始化
pitch = -asin(acc_s(1,1)/g);
roll = atan(acc_s(2,1)/acc_s(3,1));
yaw = 0;

% Conversion from the equipment coordinate system to the navigation coordinate system
C = [cos(pitch)*cos(yaw)    (sin(roll)*sin(pitch)*cos(yaw))-(cos(roll)*sin(yaw))    (cos(roll)*sin(pitch)*cos(yaw))+(sin(roll)*sin(yaw));
    cos(pitch)*sin(yaw)     (sin(roll)*sin(pitch)*sin(yaw))+(cos(roll)*cos(yaw))   (cos(roll)*sin(pitch)*sin(yaw))-(sin(roll)*cos(yaw));
    -sin(pitch)                 sin(roll)*cos(pitch)                                                 cos(roll)*cos(pitch)];
C_pre = C;

% get bias
fid=fopen('biasCircle.txt','r');
bias_data=[];
while 1
    tline=fgetl(fid);
    if ~ischar(tline),break;end
    tline=str2num(tline);
    bias_data=[bias_data;tline];
end
fclose(fid);

% Kalman matrix parameter卡尔曼矩阵参数
delta_x = zeros(15,1);
delta_x(4:6) = [bias_data(1); bias_data(2); bias_data(3);];
delta_x(13:15) = [bias_data(4); bias_data(5); bias_data(6)-g;];

%误差矩阵，diagonal 15x15 matrix
%如果P为1，则Gk为1，使用观测值来代表当前的预测值
%如果P为0，则Gk为0，使用上一次的预测值来代表当前的预测值
%因为陀螺仪(4：6)和加速度计(13：15)的数值是有噪声的，所以使用预测值而不是带有噪声的观测值
%Error matrix, 15x15
%If P is 1, then Gk is 1, using the observation value to represent the current prediction value
%If P is 0, then Gk is 0, using the previous prediction value to represent the current prediction value
%Because the values of the gyroscope (4:6) and the accelerometer (13:15) are noisy, the predicted values are used instead of the observed values with noise.
P = diag([1 1 1     0 0 0     1 1 1     1 1 1     0 0 0]);

%观测噪声协方差矩阵 Compass(1),HDR(1),ZARU(3),ZUPT(3)
%R为0，则Gk为1，使用观测值来代表当前的预测
%磁力计由于容易受外界影响，所以方差给的大，表示不是很相信他所得的数据
% observational noise covariance matrix Compass (1), HDR (1), ZARU (3), ZUPT (3)
%R is 0, and Gk is 1, using the observation value to represent the current prediction
%The magnetometer is so large that the variance is given because it is easily influenced by the outside world, indicating that the data is not very confident of the data he gets.
R = diag([ 0 0.01 0.01 0.01 0.01 0.01 0.01]); %Use 0 to indicate a total belief in the value of HDR使用0表示完全相信HDR的值
R2 = diag([ 0.01 0.01 0.01 ]);
% 系统过程噪声协方差矩阵，表示预测模型本身的噪声，初值给的很小
%The system process noise covariance matrix indicates the noise of the prediction model itself, and the initial value is very small.
Q = diag([0.0001 0.0001 0.0001 zeros(1,3) zeros(1,3) 0.0001 0.0001 0.0001  zeros(1,3)]);

% IEZ + HDR + ZARU
H = [[0 0 1]  zeros(1,3) zeros(1,3) zeros(1,3) zeros(1,3);
    zeros(3)  eye(3) zeros(3) zeros(3) zeros(3);
    zeros(3) zeros(3) zeros(3) eye(3) zeros(3)];

H3 = [zeros(3,3) zeros(3,3) zeros(3,3) zeros(3,3) zeros(3,3)];
H3(3,15) = 1;


% Record the acceleration of the navigation frame
acc_n = nan(3,datasize);
acc_n(:,1) = C*acc_s(:,1);


vel_n = nan(3,datasize);
vel_n(:,1) = [0 0 0]';

pos_n = nan(3,datasize);
pos_n(:,1) = [0 0 0]';

distance = nan(1,datasize-1);
distance(1) = 0;


heading = nan(1,datasize);
heading(1) = yaw;

sigma_noise = 1e-4;


yaw_threshold = deg2rad(4);

%Judgment stance phase
isStance = StanceDetection(acc_s, gyro_s, datasize);

% 保守校准后的数据偏差
% Data deviation after conservative calibration
tt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-8.93300285600000,-5.94669714100000,0.0754783480000000,-7.75407583300000,-11.5083691100000,-12.8603095900000,0,0,0,0.697331593000000,-0.639798285000000,1.17927238600000,1.62278096300000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0278708850000000,-1.97795274100000,-5.27193327400000,-5.97400836800000,-7.21303968900000,-6.69018957700000,0,0,0,0,0,0.537396813000000,0.495877186000000,-0.102334145000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.180060037000000,-0.815626395000000,-0.588721082000000,-0.442308713000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-6.92913395500000,-3.41363282800000,0.472885691000000,0.759626771000000,-4.90500505000000,-6.77004276200000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0304013640000000,-0.215738897000000,-1.17515682100000,-6.23108383600000,-9.05511668700000,-9.87682186800000,-7.39506516300000,-0.397800740000000,0,0,0,0,0,0,0.106185147000000,-0.134081903000000,-0.185470000000000,-0.219706760000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.188792951000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.227409082000000,0.285859023000000,0.797959135000000,1.48801910700000,1.84348752000000,0,0,0,0,0,0,0,-0.826884887000000,0,0,0,0,-0.856129183000000,-6.06094315200000,-8.27464051800000,-10.3070333900000,-9.89670294500000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.558504280000000,-2.53108960800000,-3.45658339000000,-7.28108128500000,-9.38014213100000,-9.25360333300000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.437892805000000,-2.03199621300000,-2.87096222200000,-4.34872263800000,-5.02099888800000,-4.93034734600000,-3.97891606100000,-3.21532735600000,-1.07147540600000,-0.327828258000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.311308754000000,0.828573513000000,0.851891075000000,0,0,0,0,-0.168098876000000,-5.19959747600000,-2.18032249500000,0,0,-1.70271912600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.121606861000000,-3.22852988700000,-4.30064100100000,-7.39593054200000,-9.32248255100000,-4.47663215500000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0624060620000000,-0.624970741000000,-0.445362355000000,0,0,0,0,0,-1.01572517100000,-1.66760897300000,-2.42447862600000,-2.69260966600000,-2.98533748300000,-3.01774343600000,-1.47553567600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0880215900000000,0.0200921620000000,0.188876697000000,1.09973660100000,2.79553590600000,3.77573788600000,0,0,0,0,0,0,-3.15114079400000,-4.75400627500000,-0.0452657510000000,-0.186863286000000,0.0856763230000000,-0.440217688000000,-2.56530306400000,-6.92031055700000,-8.72587939500000,0,-0.769467462000000,-1.79340542200000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.76540142600000,-3.40040640600000,-6.22295628200000,-6.32611457600000,-7.00275562400000,-5.49444115600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0474868670000000,-1.79759356200000,-2.60462097700000,-2.78626878900000,-2.46528683900000,-1.35115391200000,-0.970825578000000,-0.569395340000000,0.163393582000000,0.440404382000000,0.579433933000000,0.314225034000000,0,0,0,0,0,0,0,0,0,0,0.474295491000000,0.920177869000000,1.59401790100000,2.16760714200000,3.91430471000000,4.87297664100000,6.51078726300000,4.89133550000000,7.95415171600000,17.8166127900000,11.3543415100000,0,0,0,0,0,0,0,-1.53198857900000,-4.96899991800000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.922478515000000,-1.70996441100000,-5.80706674000000,-9.27578435700000,-10.4829432700000,-11.3689966500000,-8.78024260300000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.206427144000000,-0.826094307000000,-1.28285656500000,-1.85124897400000,-1.77930460100000,-1.52573995700000,-0.630238379000000,-0.411547325000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2.38381872900000,-2.45985396100000,0,0.170319112000000,-0.773195433000000,-1.22905750200000,-2.73811483400000,-4.32134007200000,-6.52008783900000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.358973761000000,-1.05183375200000,-2.21438676500000,-5.45253614600000,-7.21472518200000,-8.12419435000000,-7.93715473900000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.139382791000000,-1.05988291200000,-1.60015773200000,-1.98960653700000,-1.88137778300000,-1.75883875600000,-1.20492362800000,-1.07438383600000,-0.336467104000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.116373082000000,1.97857049700000,2.21244596100000,0,0,0,0,0,-2.05210612800000,-1.10144455200000,0,0,0,0,-2.03704556900000,-5.45941491700000,-6.33401552000000,-5.37694624800000,0,-4.79571335400000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.942548429000000,-2.41688297200000,-4.71106135200000,-8.72347672000000,-10.3503542800000,-9.26786320800000,-3.48513650300000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.390612274000000,-0.949958335000000,-1.40428924400000,-2.18372449000000,-2.54227501600000,-2.45381391100000,-1.88596367800000,-1.57862583300000,-0.575337948000000,-0.357713975000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.200675955000000,0.928158632000000,3.15087698500000,0,0,0,0,0,-1.81879285400000,0,0,0,0,0,-0.388147493000000,-2.34212049900000,-6.69554731600000,0,0,0,0,0,0.875958953000000,1.98645794700000,-0.292756974000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.18260985300000,-0.681877428000000,-4.20156050600000,-8.54981481300000,-9.77555774900000,-10.5378587000000,-9.91655386200000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.659002241000000,-0.234594655000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.655562581000000,1.67648770100000,4.62083862500000,6.27015035600000,0,0,0,0,-2.44676509800000,-5.47658924100000,-0.637482343000000,0,0,0,0,0,-3.70728358300000,-4.68152012600000,-5.87407756500000,-6.44370207100000,-4.47810318900000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.614056445000000,-1.35790658100000,-1.89947609300000,-6.01205348300000,-8.22041749100000,-11.1732645900000,-6.45776925100000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.176236211000000,-0.408166606000000,-0.527355138000000,-0.756279870000000,-0.961251262000000,-0.834304247000000,0,0,-0.643032942000000,-2.16306922400000,-2.68340925500000,-2.91149929800000,-3.00628064500000,-2.88849579800000,-3.09829707300000,-3.09695481000000,-2.95511344200000,-1.77088374200000,-0.291945552000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0.495206644000000,0.950187802000000,2.04092620900000,0,0,0,0,0,0,-3.89855451200000,0,0,0,0,0,-3.00162438500000,-4.24300650400000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.12035661600000,-2.69908841100000,-1.80469315100000,-3.27305037500000,-6.52324662100000,-11.7248172700000,-11.0341679100000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.770524097000000,-1.24302547300000,-1.44955717000000,-1.53122711600000,-1.22839164100000,-0.983092957000000,-1.08798518200000,-0.767484463000000,-0.630433308000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-5.68463537400000,-9.14118978400000,-4.30056203200000,-1.02807642300000,-0.539195545000000,0,-1.73060034600000,-4.02602407900000,-6.13449717000000,-6.38169098700000,-6.99350631500000,-4.70591494500000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.509385963000000,-1.38122809100000,-2.64229317900000,-5.77597722900000,-8.12019925200000,-9.64407173800000,-8.76462882700000,-5.35093226600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.120176172000000,-0.798288021000000,-1.24710562000000,-1.94083546900000,-2.49288665700000,-2.81279761600000,-2.95873750300000,-2.96118052000000,-2.39909042400000,-2.14748191400000,-1.09262181700000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2.27202276100000,-4.08445803800000,-2.25922313700000,0,0,-2.79422190400000,-4.01510755200000,-7.15537510600000,-8.25704203100000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-3.15537524500000,-0.916024262000000,0,-2.93990449500000,-6.26521823300000,-7.51446524400000,-8.18165024800000,-7.00630404400000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.126961846000000,-0.656392660000000,-1.27863768900000,-1.46389961300000,-1.26405014400000,-0.296037829000000,-0.169231231000000,0.0151459970000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.329414456000000,-4.94150431000000,-1.37635128100000,-0.969059982000000,-0.446106199000000,-1.34649456000000,-4.70453778500000,-8.11640839200000,-8.82988219100000,-6.84320152600000,0,0,0,0,2.23335573000000,1.37650830100000,0.485041418000000,0.422607075000000,0.576498569000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0850216110000000,0.206303199000000,0.263173195000000,0.246126823000000,0.814799128000000,1.01752110000000,1.96525161400000,2.96760449000000,4.32465251600000,7.10046133000000,6.98480539600000,5.13529952500000,4.51926640400000,0.217759694000000,-1.12279954800000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.167680856000000,-0.217265031000000,-0.325453986000000,-0.557375270000000,-0.588998046000000,-0.488099106000000,0.0851654110000000,0,-0.439560033000000,-1.64779065300000,-2.20202966400000,-2.68737752900000,-2.89359605900000,-2.81604813800000,-2.69338385100000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3.11774867500000,2.71075698100000,0,0,0,0,0,-2.45634125700000,-5.26896724800000,-0.804625506000000,-0.213161753000000,-1.96822038100000,-3.16099552200000,-6.56353602200000,-8.26980274600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.957683304000000,-1.02707982800000,-3.25961612500000,-4.86292595700000,-7.98691887800000,-9.33771669200000,-12.3109274300000,-11.5383422600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.14411851500000,-1.77318208000000,-2.31287916600000,-1.96644705500000,-1.84242959200000,-1.13630581700000,-0.938425077000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-5.75141248900000,-5.37307731500000,0,0,0,0,-2.51057322900000,-4.93470410900000,-7.97618978300000,-9.02862258900000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-3.88857112000000,-5.97437868500000,-7.64958721700000,-10.4477263000000,-10.1422349400000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.368639055000000,-0.691559606000000,-0.792669583000000,-0.207674940000000,-0.0992190540000000,0.0242678980000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.96758837000000,2.24298550600000,0,0,0,0,0,0,0,0,0,0,0,-0.215654981000000,-2.00621398600000,-6.03330032700000,-7.38547601600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.52314056200000,-0.989540555000000,-2.24755147200000,-3.25884149900000,-5.94984553700000,-7.36824248600000,-8.86772114700000,-4.54731742100000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.868162499000000,-1.34703159400000,-1.86149604800000,-2.09027519000000,-2.09884402200000,-2.06430926700000,-1.51331478700000,-0.800996807000000,-0.569727012000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.339016670000000,2.23862613600000,3.54349062600000,5.93940669400000,7.37350605000000,-0.0676085670000000,0,0,-0.523162826000000,-5.13766373500000,-8.37236030900000,-1.07559465000000,0,0,0,0,0,-1.95529679800000,-3.91318620300000,0,-3.78059927700000,-7.18174172800000,-6.38827419900000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.182040090000000,-2.12404812300000,-4.73094491600000,-8.35994477000000,-9.61325591700000,-8.13363133200000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.293701924000000,-0.783451455000000,-1.39250163500000,-1.28777351700000,-0.895030499000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.565782774000000,1.85647525100000,5.13216614900000,0,0,0,0,0,0,0,0,0,-0.751306381000000,-1.64441266800000,-1.99354678900000,-3.05433325500000,-4.11155024800000,-5.23355622800000,-7.88951465900000,0,0,0,-2.14665941200000,-2.72063206700000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.90658318500000,-4.75928615800000,-7.50994534600000,-9.53462867100000,-9.32774933500000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.350492724000000,-0.819316046000000,-1.76988645700000,-2.09539437600000,-2.19949852900000,-2.47773865200000,-2.78440747200000,-2.78110620200000,-2.43332462200000,-1.18575283700000,-0.975585048000000,-0.709484044000000,-0.502217906000000,-0.469751553000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.537371580000000,3.21606576100000,5.18929264500000,8.99115863800000,10.4445711400000,12.4350822700000,10.4683356400000,1.27784790300000,0,0,0,0,0,0,0,0,0,0,-2.28881204500000,-7.48647419900000,-9.42238199000000,-11.0750619800000,-11.4550202500000,-0.402725751000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.50389744900000,-3.98165919100000,-6.26168889200000,-10.5696812500000,-11.6289148000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.275554913000000,-0.553783656000000,-0.402034419000000,-0.512438686000000,-0.445312783000000,-0.661715857000000,-1.05438105700000,-1.23793068600000,-1.16465112300000,-1.19480229000000,-0.865599862000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.233750500000000,1.08136762200000,4.21625036800000,2.53319670300000,0,0,0,0,0,0,0,0,0,0,0,0,0,-3.89987345100000,-9.45708040600000,-9.57159802500000,-2.98326304600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.502433725000000,-0.329348382000000,-2.34342134000000,-5.72345165500000,-7.12118202400000,-10.9569735300000,-8.49281318800000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.680283230000000,-1.31062562100000,-2.03454039800000,-2.13407512200000,-1.81386918800000,-1.88852375100000,-2.13505637500000,-2.51474445900000,-2.88166029000000,-3.08024589100000,-2.80662729200000,-1.22235882900000,-0.421522727000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.152675501000000,2.30987641300000,4.15491692400000,0,0,0,0,0,-2.50422475200000,-1.96213927200000,0,0,0,0,0,0,-1.34305716200000,-2.36093761600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2.09747904800000,-1.87962905700000,-4.69787383400000,-7.29790366300000,-8.82637367400000,-11.3762934800000,-12.2268287600000,-5.78331560000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0978420160000000,0.372285301000000,7.66103212900000,8.38237414600000,11.1095441400000,0,0,0,0,-0.691451407000000,-2.24939923900000,-2.03541110100000,-3.76929973000000,-5.86714194200000,-7.60986684400000,-8.26935783100000,-7.64107644700000,-7.65230790400000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.712918916000000,-0.279175033000000,-4.18872654900000,-6.75878184500000,-9.48885987200000,-4.22982777500000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1.15845880500000,-1.83259984100000,-2.27640508700000,-2.29762138700000,-2.50829356700000,-2.05447884400000,-1.72845085400000,-0.976767765000000,-0.903652853000000,-0.703795902000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.88889808100000,3.85468153500000,5.96052932100000,0,0,0,0,0,-3.51774516400000,-1.68308862900000,0,0,0,0,0,-2.71763387000000,-4.87219607000000,-7.37181634500000,-7.46427074500000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.265773265000000,-0.166199670000000,-2.63275149400000,-4.54890666700000,-8.19532150800000,-8.29878219300000,-8.35121610600000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.918709705000000,2.15457617700000,2.66971271900000,0,0,0,0,-5.72896446200000,-7.91123793600000,0,0,0,0,0,0,-2.58682600000000,-3.82122358100000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-3.41433680100000,-5.03019195800000,-8.60159046500000,-10.9665654100000,-7.73878924100000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.253471470000000,-1.51346724100000,-2.30109040500000,-2.80826388000000,-2.80459054500000,-1.80056723400000,-1.33390337300000,-0.466307094000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.13203823800000,1.94753391000000,4.63674510200000,0,0,0,8.51823530400000,3.62565348100000,0,0,0,0,0,0,-2.41469094200000,-4.13494270000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-4.46291442800000,-6.22197901100000,-8.61272212600000,-7.83927908900000,-1.42097715800000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.566550967000000,-1.04989767500000,-1.88047822600000,-2.02634882600000,-1.33399412600000,-0.642804625000000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.639732069000000,1.15312883700000,1.78914315300000,0,0,0,0,0,0,0,0,0,0,0,-6.55856482500000,-8.82115039800000,-3.13966718400000,0,0,-3.17487852800000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
%% main loop
for t = 2:datasize
    dt = timestamp(t) - timestamp(t-1); %translate time
    
    % first phase:gyro acc Remove bias
    gyro_s1 = gyro_s(:,t) - delta_x(4:6);
    
    
    % second phase:Angular rate anti symmetric matrix角速率反对称矩阵
    delta_omiga = [0              -gyro_s1(3)     gyro_s1(2);
                   gyro_s1(3)     0               -gyro_s1(1);
                  -gyro_s1(2)   gyro_s1(1)     0];
    
    % 方向转换矩阵的计算 
    % calculate the direction transition matrix
    C = C_pre*(2*eye(3)+(delta_omiga*dt))/(2*eye(3)-(delta_omiga*dt));
    
    %更新方向角
    % update direction angle
    pitch = -asin(C(3,1));
    roll = atan(C(3,2)/C(3,3));
    yaw = atan(C(2,1)/C(1,1));
   
    %third phase:加速度转换框架
    acc_n(:,t) = 0.5*(C + C_pre)*(acc_s(:,t)-delta_x(13:15));
    
     %%micro gait--------------------------------------------
	 
  if t>10000%To judge whether to perform the calibration of the micro gait
    K = (P*(H3)')/((H3)*P*(H3)' + R2); %
        
        m = [tt(:,t)];% error observation matrix
        
        delta_x = delta_x + K*(m - H3*delta_x);
        
     
        P = (eye(15) - K*H3)*P;
        
          acc_n(:,t)=acc_n(:,t) - delta_x(13:15);
        
        %recovery error state恢复误差状态
        delta_x(13:15) = zeros(3,1);
    %%--------------------------------------------------------
  end 
    %fourth phase:get velocity and position
    vel_n(:,t) = vel_n(:,t-1) + (acc_n(:,t) - [0; 0; g] )*dt;
    pos_n(:,t) = pos_n(:,t-1) + vel_n(:,t)*dt;
    
   
    S = [0             -acc_n(3)   acc_n(2);
         acc_n(3)       0           -acc_n(1);
        -acc_n(2)       acc_n(1)       0];
    
    % % state transition matrix状态转移矩阵，
    F = [eye(3)        dt*C    zeros(3)  zeros(3)   zeros(3);
        zeros(3)      eye(3)        zeros(3)  zeros(3)   zeros(3);
        zeros(3)      zeros(3)     eye(3)     dt*eye(3) zeros(3)
        -dt*S          zeros(3)     zeros(3)   eye(3)     dt*C
        zeros(3)      zeros(3)     zeros(3)   zeros(3)  eye(3)];
    
    % % prediction预测
    delta_x = F*delta_x;
    P = F*P*F' + Q;
  
    
    %%HDR
   
    ret_yaw = HDR(yaw, heading,t);
    
    if(abs(ret_yaw) < yaw_threshold)
        delta_yaw_hdr = ret_yaw;
    else
        delta_yaw_hdr = 0;
    end
    
    % judge stance
    if(isStance(t) == 1)
        K = (P*(H)')/((H)*P*(H)' + R); 
        
        m = [delta_yaw_hdr;
            ZARU(gyro_s(:,t));
            (vel_n(:,t) - [0 0 0]')];
        
        delta_x = delta_x + K*(m - H*delta_x);
        
        % % updated noise covariance matrix
        P = (eye(15) - K*H)*P;
        
        %%更新姿态
        ang_matrix = -[0            -delta_x(3)    delta_x(2);
            delta_x(3)         0         -delta_x(1);
            -delta_x(2)  delta_x(1)         0];
        
        C = (2*eye(3)+(ang_matrix))/(2*eye(3)-(ang_matrix))*C;
        
        %fifth phase:% calibration
        vel_n(:,t)=vel_n(:,t) - delta_x(10:12);
        pos_n(:,t)=pos_n(:,t) - delta_x(7:9);
        
        %% recovery error state恢复误差状态
        delta_x(1:3) = zeros(3,1);
        delta_x(7:9) = zeros(3,1);
        delta_x(10:12) = zeros(3,1);
        
    end
        
    heading(t) = yaw; %保存yaw角 Save yaw angle
    C_pre = C; % 保存方向 save direction data
    distance(1,t) = distance(1,t-1) + sqrt((pos_n(1,t)-pos_n(1,t-1))^2 + (pos_n(2,t)-pos_n(2,t-1))^2);% 计算距离 calculate distance
end


%绘制轨迹
%plot trajectory
figure;
box on;
hold on;
angle = 180; %要求达到图片审美对齐的角度，所以旋转图形 The point of view of the aesthetic alignment of the picture，so rotating graphics
rotation_matrix = [cosd(angle)  -sind(angle);
    sind(angle)   cosd(angle)];

pos_r = zeros(2,datasize);

for idx = 1:datasize
    pos_r(:,idx) = rotation_matrix*[pos_n(1,idx) pos_n(2,idx)]';
end
%绘制路线 Draw a route
plot(pos_r(1,:),pos_r(2,:),'LineWidth',2,'Color','r');
%绘制开始符号 Draw the start symbol
start = plot(pos_r(1,1),pos_r(2,1),'Marker','^','LineWidth',1,'LineStyle','none');
%绘制结束符号 Draw the end symbol
stop = plot(pos_r(1,end),pos_r(2,end),'Marker','o','LineWidth',1,'LineStyle','none');

xlabel('x (m)');
ylabel('y (m)');
title('平面路线估计');
legend([start;stop],'开始','结束');
axis equal;
grid;
hold off;
